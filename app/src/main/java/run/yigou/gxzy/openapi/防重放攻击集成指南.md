# 防重放攻击集成指南

## 1. 功能概述

本文档旨在详细介绍如何将防重放攻击功能集成到项目中。防重放攻击是一种重要的网络安全机制，通过时间戳和随机数（Nonce）的组合使用，有效防止攻击者重复发送相同的请求，保障系统安全。

## 2. 技术实现

### 2.1 核心组件

#### 2.1.1 SecurityConfig（安全配置类）

[SecurityConfig](file:///D:/git/app/AndroidProject/app/src/main/java/run/yigou/gxzy/http/security/SecurityConfig.java#L13-L251) 是一个静态配置类，用于管理防重放攻击相关的配置信息。

主要功能：
1. 存储 AccessKey ID 和密钥
2. 控制防重放攻击功能的启用/禁用状态
3. 生成时间戳和Nonce
4. 生成请求签名
5. 构建查询字符串和请求体字符串

#### 2.1.2 RequestHelper（请求辅助类）

[RequestHelper](file:///D:/git/app/AndroidProject/app/src/main/java/run/yigou/gxzy/http/security/RequestHelper.java#L12-L82) 是一个辅助类，用于提取请求相关信息。

主要功能：
1. 获取请求方法
2. 获取主机地址
3. 获取请求路径
4. 获取请求体类型

#### 2.1.3 InterceptorHelper（拦截器辅助类）

[InterceptorHelper](file:///D:/git/app/AndroidProject/app/src/main/java/run/yigou/gxzy/http/security/InterceptorHelper.java#L16-L73) 是一个辅助类，用于处理请求拦截逻辑。

主要功能：
1. 添加全局请求头
2. 添加防重放攻击相关头部

### 2.2 集成方式

防重放攻击功能已集成到 [AppApplication](file:///D:/git/app/AndroidProject/app/src/main/java/run/yigou/gxzy/app/AppApplication.java#L61-L355) 类中，通过 EasyHttp 的 `setInterceptor` 方法实现：

```java
.setInterceptor((api, params, headers) -> {
    InterceptorHelper.handleIntercept(api, params, headers, this);
})
```

完整的集成代码如下：

```java
.setInterceptor((api, params, headers) -> {
    // 添加全局请求头
    // ... 其他头部
    
    // 添加防重放攻击相关头部
    if (SecurityConfig.isAntiReplayAttackEnabled()) {
        String accessKeyId = SecurityConfig.getAccessKeyId();
        String accessKeySecret = SecurityConfig.getAccessKeySecret();
        
        // 只有当配置了AccessKey时才添加相关头部
        if (accessKeyId != null && !accessKeyId.isEmpty() && 
            accessKeySecret != null && !accessKeySecret.isEmpty()) {
            
            // 获取请求相关信息
            String method = RequestHelper.getRequestMethod(api, params);
            String host = RequestHelper.getHost();
            String path = RequestHelper.getPath(api);
            String queryString = SecurityConfig.buildQueryString(api, params);
            
            // 构建请求体
            BodyType bodyType = RequestHelper.getBodyType();
            String bodyString = SecurityConfig.buildBodyString(api, params, bodyType);
            
            // 生成签名
            String signature = SecurityConfig.generateSignature(api, method, host, path, queryString, bodyString);
            
            // 添加防重放攻击头部
            headers.put("Signature", "Signature " + signature);
            headers.put("X-AccessKeyId", accessKeyId);
            headers.put("X-Timestamp", SecurityConfig.getCurrentTimestamp());
            headers.put("X-Nonce", SecurityConfig.generateNonce());
        }
    }
})
```

## 3. 使用方法

### 3.1 配置 AccessKey

在应用启动时或需要启用防重放攻击功能前，配置 AccessKey：

```java
// 设置 AccessKey ID 和密钥
SecurityConfig.setAccessKeyId("your-access-key-id");
SecurityConfig.setAccessKeySecret("your-access-key-secret");

// 启用防重放攻击功能
SecurityConfig.enableAntiReplayAttack();
```

### 3.2 禁用功能

如果需要临时禁用防重放攻击功能：

```java
// 禁用防重放攻击功能
SecurityConfig.disableAntiReplayAttack();
```

### 3.3 检查状态

可以随时检查功能是否启用：

```java
// 检查是否启用了防重放攻击功能
if (SecurityConfig.isAntiReplayAttackEnabled()) {
    // 功能已启用
} else {
    // 功能未启用
}
```

## 4. 工作原理

### 4.1 防重放攻击机制

1. **时间戳验证**：
   - 客户端生成当前时间戳
   - 服务器验证时间戳是否在有效时间窗口内（通常为±5分钟）
   - 超出时间窗口的请求直接拒绝

2. **Nonce 唯一性验证**：
   - 客户端生成随机数（Nonce）
   - 服务器检查该 Nonce 是否已使用
   - 已使用的 Nonce 在一定时间内不允许重复使用

### 4.2 签名算法

签名算法使用 HmacSHA256，签名字符串的构造方式如下：

```
Method
Host
Path
Query
Body
Timestamp
Nonce
```

其中：
- Method: HTTP请求方法（GET、POST等）
- Host: 请求主机地址
- Path: 请求路径
- Query: 查询参数字符串
- Body: 请求体内容
- Timestamp: 当前时间戳
- Nonce: 随机字符串

### 4.3 综合防护

通过时间戳和 Nonce 的结合使用，确保请求的唯一性和时效性，有效防止重放攻击。

## 5. 请求头部说明

启用防重放攻击功能后，每个 HTTP 请求都会自动添加以下头部：

| 头部名称 | 说明 |
|---------|------|
| `Signature` | 签名结果，格式为"Signature [签名值]" |
| `X-AccessKeyId` | AccessKey ID |
| `X-Timestamp` | 时间戳（毫秒） |
| `X-Nonce` | 随机字符串 |

## 6. 辅助方法说明

### 6.1 generateSignature

生成请求签名：

```java
String signature = SecurityConfig.generateSignature(api, method, host, path, queryString, bodyString);
```

### 6.2 buildQueryString

构建查询字符串：

```java
String queryString = SecurityConfig.buildQueryString(api, params);
```

### 6.3 buildBodyString

构建请求体字符串：

```java
String bodyString = SecurityConfig.buildBodyString(api, params, bodyType);
```

### 6.4 RequestHelper中的方法

#### getRequestMethod
获取请求方法：
```java
String method = RequestHelper.getRequestMethod(api, params);
```

#### getHost
获取主机地址：
```java
String host = RequestHelper.getHost();
```

#### getPath
获取请求路径：
```java
String path = RequestHelper.getPath(api);
```

#### getBodyType
获取请求体类型：
```java
BodyType bodyType = RequestHelper.getBodyType();
```

## 7. 注意事项

1. **默认禁用**：为避免兼容性问题，防重放攻击功能默认是禁用的
2. **按需启用**：只有在设置了 AccessKey 并显式启用功能后才会生效
3. **安全存储**：AccessKey 应当安全存储，避免硬编码在代码中
4. **服务端配合**：需要服务端实现对应的验证逻辑才能真正起到防护作用

## 8. 故障排除

### 8.1 功能未生效

请检查以下几点：
1. 是否已正确设置 AccessKey ID 和密钥
2. 是否已调用 `SecurityConfig.enableAntiReplayAttack()` 启用功能
3. 服务端是否已实现对应的验证逻辑