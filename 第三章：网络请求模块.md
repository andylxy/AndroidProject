# 第三章：网络请求模块

## 3.1 EasyHttp 网络框架介绍

本项目使用的是作者自己开发的网络请求框架 [EasyHttp](https://github.com/getActivity/EasyHttp)，而不是 Retrofit 或 OkHttp 等其他框架。在项目的 [HelpDoc.md](file:///D:/git/app/AndroidProject/HelpDoc.md) 文件中，作者详细解释了为什么没有使用 Retrofit 和 RxJava，而是自己开发了 EasyHttp。

### 为什么选择 EasyHttp？

1. **功能更全面**：相比 Retrofit，EasyHttp 内置了更多常用功能，如添加通用请求头和参数、请求和响应的日志打印、动态 Host 及多域名配置等。

2. **更加灵活**：EasyHttp 支持上传进度监听等 Retrofit 不支持的功能。

3. **学习成本低**：不需要学习复杂的注解系统，使用更加简单直观。

## 3.2 网络请求的基本使用方法

### 配置服务器地址

在 [RequestServer.java](file:///D:/git/app/AndroidProject/app/src/main/java/run/yigou/gxzy/http/Server/RequestServer.java#L18-L44) 文件中配置服务器地址：

```java
public class RequestServer implements IRequestServer {
    @Override
    public String getHost() {
        // 返回服务器主机地址
        return "https://www.baidu.com/";
    }

    @Override
    public String getPath() {
        // 返回 API 路径前缀
        return "/api/";
    }
}
```

### 创建 API 接口类

每个网络请求都需要创建一个对应的 API 类，例如获取用户信息的接口：

```java
public final class UserInfoApi implements IRequestApi {
    @Override
    public String getApi() {
        // 返回具体的 API 地址
        return "user/info";
    }

    // 返回数据的实体类
    public final class Bean {
        // 这里定义返回数据的字段
    }
}
```

### 发送网络请求

在 Activity 或 Fragment 中发送网络请求：

```java
// 发送 GET 请求
EasyHttp.get(this)
    .api(new UserInfoApi())
    .request(new OnHttpListener<UserInfoApi.Bean>() {
        @Override
        public void onStart(Call call) {
            // 请求开始，显示加载对话框
        }

        @Override
        public void onSucceed(UserInfoApi.Bean result) {
            // 请求成功，处理返回的数据
        }

        @Override
        public void onFail(Exception e) {
            // 请求失败，显示错误信息
        }

        @Override
        public void onEnd(Call call) {
            // 请求结束，隐藏加载对话框
        }
    });
```

## 3.3 网络请求的高级功能

### 添加请求头和参数

```java
EasyHttp.post(this)
    .api(new LoginApi())
    .addParam("username", "admin")
    .addParam("password", "123456")
    .addHeader("Authorization", "Bearer token")
    .request(new OnHttpListener<LoginApi.Bean>() {
        // 处理请求结果
    });
```

### 文件上传

```java
EasyHttp.post(this)
    .api(new UploadApi())
    .body(new FileBody.Builder()
        .addFile("file", new File("/sdcard/test.jpg"))
        .build())
    .request(new OnHttpListener<UploadApi.Bean>() {
        // 处理上传结果
    });
```

### 请求缓存

EasyHttp 支持请求缓存功能，可以减少重复请求：

```java
EasyHttp.get(this)
    .api(new UserInfoApi())
    .cache(new CacheMode.CacheStrategy())
    .request(new OnHttpListener<UserInfoApi.Bean>() {
        // 处理结果
    });
```

## 3.4 网络请求的统一处理

在 [AppActivity](file:///D:/git/app/AndroidProject/app/src/main/java/run/yigou/gxzy/app/AppActivity.java#L25-L230) 和 [AppFragment](file:///D:/git/app/AndroidProject/app/src/main/java/run/yigou/gxzy/app/AppFragment.java#L16-L76) 中已经实现了网络请求的统一处理：

1. **自动显示加载对话框**：在请求开始时自动显示
2. **自动隐藏加载对话框**：在请求结束时自动隐藏
3. **统一错误处理**：自动显示错误信息

## 3.5 实际使用示例

以下是一个完整的登录请求示例：

```java
// 1. 创建登录 API 类
public final class LoginApi implements IRequestApi {
    @Override
    public String getApi() {
        return "user/login";
    }
    
    private String username;
    private String password;
    
    public LoginApi setUsername(String username) {
        this.username = username;
        return this;
    }
    
    public LoginApi setPassword(String password) {
        this.password = password;
        return this;
    }
    
    public final class Bean {
        private String token;
        private UserInfo userInfo;
        
        // getter 和 setter 方法
    }
}

// 2. 在 Activity 中发送登录请求
public class LoginActivity extends AppActivity {
    
    private void login(String username, String password) {
        EasyHttp.post(this)
            .api(new LoginApi()
                .setUsername(username)
                .setPassword(password))
            .request(new OnHttpListener<LoginApi.Bean>() {
                @Override
                public void onStart(Call call) {
                    // 基类自动处理，显示加载对话框
                }
                
                @Override
                public void onSucceed(LoginApi.Bean result) {
                    // 登录成功，保存用户信息
                    saveUserInfo(result.getToken(), result.getUserInfo());
                    // 跳转到主页面
                    startActivity(new Intent(LoginActivity.this, MainActivity.class));
                    finish();
                }
                
                @Override
                public void onFail(Exception e) {
                    // 基类自动处理，显示错误信息
                }
                
                @Override
                public void onEnd(Call call) {
                    // 基类自动处理，隐藏加载对话框
                }
            });
    }
}
```

## 本章小结

这一章我们学习了：

1. 项目使用 EasyHttp 作为网络请求框架的原因
2. 如何配置服务器地址和创建 API 接口类
3. 如何发送基本的网络请求
4. 网络请求的高级功能，如添加参数、文件上传等
5. 网络请求的统一处理机制
6. 一个完整的登录请求示例

掌握了这些内容，你就能够在这个项目中进行各种网络请求操作了。