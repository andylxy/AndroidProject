# 第八章：实际开发练习

## 8.1 创建一个新的功能页面

在这一节中，我们将通过创建一个新的功能页面来练习前面学到的知识。

### 创建页面布局文件

首先创建一个布局文件 `activity_demo.xml`：

```xml
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical">

    <!-- 标题栏 -->
    <com.hjq.bar.TitleBar
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:title="演示页面" />

    <!-- 内容区域 -->
    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        android:orientation="vertical"
        android:padding="16dp">

        <!-- 用户名输入框 -->
        <com.hjq.widget.view.RegexEditText
            android:id="@+id/et_username"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:hint="请输入用户名" />

        <!-- 密码输入框 -->
        <com.hjq.widget.view.PasswordEditText
            android:id="@+id/et_password"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:layout_marginTop="16dp"
            android:hint="请输入密码" />

        <!-- 登录按钮 -->
        <Button
            android:id="@+id/btn_login"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:layout_marginTop="24dp"
            android:text="登录" />

        <!-- 结果显示区域 -->
        <TextView
            android:id="@+id/tv_result"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:layout_marginTop="24dp"
            android:gravity="center"
            android:text="登录结果将显示在这里"
            android:textSize="16sp" />

    </LinearLayout>

</LinearLayout>
```

### 创建页面 Activity

创建 [DemoActivity.java](file:///D:/git/app/AndroidProject/app/src/main/java/run/yigou/gxzy/ui/activity/DemoActivity.java) 文件：

```java
package run.yigou.gxzy.ui.activity;

import android.os.Bundle;
import android.view.View;
import android.widget.Button;
import android.widget.TextView;

import run.yigou.gxzy.R;
import run.yigou.gxzy.app.AppActivity;
import run.yigou.gxzy.http.api.LoginApi;
import run.yigou.gxzy.http.model.HttpData;
import com.hjq.http.EasyHttp;
import com.hjq.http.listener.HttpCallback;
import com.hjq.widget.view.RegexEditText;
import com.hjq.widget.view.PasswordEditText;

/**
 * 演示页面
 */
public class DemoActivity extends AppActivity 
        implements View.OnClickListener {
    
    private RegexEditText etUsername;
    private PasswordEditText etPassword;
    private Button btnLogin;
    private TextView tvResult;
    
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_demo);
        
        initView();
    }
    
    private void initView() {
        etUsername = findViewById(R.id.et_username);
        etPassword = findViewById(R.id.et_password);
        btnLogin = findViewById(R.id.btn_login);
        tvResult = findViewById(R.id.tv_result);
        
        // 设置按钮点击监听
        btnLogin.setOnClickListener(this);
        
        // 限制用户名只能输入字母和数字
        etUsername.setPatternRegex("[a-zA-Z0-9]*");
    }
    
    @Override
    public void onClick(View v) {
        if (v == btnLogin) {
            // 处理登录按钮点击
            handleLogin();
        }
    }
    
    private void handleLogin() {
        String username = etUsername.getText().toString().trim();
        String password = etPassword.getText().toString().trim();
        
        // 简单的输入验证
        if (username.isEmpty() || password.isEmpty()) {
            tvResult.setText("用户名或密码不能为空");
            return;
        }
        
        // 显示加载中
        tvResult.setText("登录中...");
        
        // 发送登录请求（模拟）
        simulateLogin(username, password);
    }
    
    /**
     * 模拟登录请求
     */
    private void simulateLogin(String username, String password) {
        // 在实际项目中，这里会发送真实的网络请求
        // 这里我们使用 postDelayed 来模拟网络延迟
        getWindow().getDecorView().postDelayed(() -> {
            // 模拟登录成功
            if ("admin".equals(username) && "123456".equals(password)) {
                tvResult.setText("登录成功");
            } else {
                tvResult.setText("用户名或密码错误");
            }
        }, 2000);
    }
}
```

### 在清单文件中注册

在 `AndroidManifest.xml` 中添加页面声明：

```xml
<activity android:name=".ui.activity.DemoActivity" />
```

## 8.2 实现网络请求功能

在这一节中，我们将练习如何使用项目中的网络请求框架。

### 创建 API 类

创建一个获取用户信息的 API 类：

```java
package run.yigou.gxzy.http.api;

import com.hjq.http.config.IRequestApi;

/**
 * 获取用户信息 API
 */
public class GetUserInfoApi implements IRequestApi {
    
    private String userId;
    
    @Override
    public String getApi() {
        return "user/info";
    }
    
    public GetUserInfoApi setUserId(String userId) {
        this.userId = userId;
        return this;
    }
    
    public static class Bean {
        private String userId;
        private String username;
        private String email;
        
        // getter 和 setter 方法
        public String getUserId() {
            return userId;
        }
        
        public void setUserId(String userId) {
            this.userId = userId;
        }
        
        public String getUsername() {
            return username;
        }
        
        public void setUsername(String username) {
            this.username = username;
        }
        
        public String getEmail() {
            return email;
        }
        
        public void setEmail(String email) {
            this.email = email;
        }
    }
}
```

### 在页面中使用网络请求

修改 [DemoActivity.java](file:///D:/git/app/AndroidProject/app/src/main/java/run/yigou/gxzy/ui/activity/DemoActivity.java) 添加网络请求功能：

```java
// 添加网络请求方法
private void fetchUserInfo() {
    EasyHttp.get(this)
        .api(new GetUserInfoApi().setUserId("123"))
        .request(new HttpCallback<HttpData<GetUserInfoApi.Bean>>() {
            @Override
            public void onStart(Call call) {
                // 请求开始，基类会自动显示加载对话框
                tvResult.setText("正在获取用户信息...");
            }
            
            @Override
            public void onSucceed(HttpData<GetUserInfoApi.Bean> result) {
                // 请求成功
                GetUserInfoApi.Bean userInfo = result.getData();
                if (userInfo != null) {
                    String info = "用户名: " + userInfo.getUsername() + 
                                 "\n邮箱: " + userInfo.getEmail();
                    tvResult.setText(info);
                } else {
                    tvResult.setText("未获取到用户信息");
                }
            }
            
            @Override
            public void onFail(Exception e) {
                // 请求失败，基类会自动显示错误信息
                tvResult.setText("获取用户信息失败: " + e.getMessage());
            }
            
            @Override
            public void onEnd(Call call) {
                // 请求结束，基类会自动隐藏加载对话框
            }
        });
}
```

## 8.3 数据库操作练习

在这一节中，我们将练习数据库的基本操作。

### 创建实体类

创建一个简单的笔记实体类：

```java
package run.yigou.gxzy.greendao.entity;

import org.greenrobot.greendao.annotation.Entity;
import org.greenrobot.greendao.annotation.Id;
import org.greenrobot.greendao.annotation.Generated;

/**
 * 笔记实体类
 */
@Entity
public class Note {
    @Id(autoincrement = true)
    private Long id;
    
    private String title;
    private String content;
    private long createTime;
    private long updateTime;
    
    @Generated(hash = 123456789)
    public Note() {
    }
    
    @Generated(hash = 987654321)
    public Note(Long id, String title, String content, 
                long createTime, long updateTime) {
        this.id = id;
        this.title = title;
        this.content = content;
        this.createTime = createTime;
        this.updateTime = updateTime;
    }
    
    // getter 和 setter 方法
    public Long getId() {
        return id;
    }
    
    public void setId(Long id) {
        this.id = id;
    }
    
    public String getTitle() {
        return title;
    }
    
    public void setTitle(String title) {
        this.title = title;
    }
    
    public String getContent() {
        return content;
    }
    
    public void setContent(String content) {
        this.content = content;
    }
    
    public long getCreateTime() {
        return createTime;
    }
    
    public void setCreateTime(long createTime) {
        this.createTime = createTime;
    }
    
    public long getUpdateTime() {
        return updateTime;
    }
    
    public void setUpdateTime(long updateTime) {
        this.updateTime = updateTime;
    }
}
```

### 创建服务类

创建笔记服务类：

```java
package run.yigou.gxzy.greendao.service;

import run.yigou.gxzy.greendao.entity.Note;
import run.yigou.gxzy.greendao.gen.NoteDao;

/**
 * 笔记服务类
 */
public class NoteService extends BaseService<Note, NoteDao> {
    
    private static class SingletonHolder {
        private static final NoteService INSTANCE = new NoteService();
    }
    
    public static NoteService getInstance() {
        return SingletonHolder.INSTANCE;
    }
    
    @Override
    protected Class<Note> getEntityClass() {
        return Note.class;
    }
    
    @Override
    protected NoteDao getDao() {
        tableName = NoteDao.TABLENAME;
        return daoSession.getNoteDao();
    }
    
    @Override
    protected void createTable() {
        NoteDao.createTable(mDatabase, true);
    }
    
    /**
     * 添加笔记
     */
    public long addNote(Note note) {
        note.setCreateTime(System.currentTimeMillis());
        note.setUpdateTime(System.currentTimeMillis());
        return insert(note);
    }
    
    /**
     * 更新笔记
     */
    public void updateNote(Note note) {
        note.setUpdateTime(System.currentTimeMillis());
        update(note);
    }
    
    /**
     * 删除笔记
     */
    public void deleteNote(long noteId) {
        deleteByKey(noteId);
    }
    
    /**
     * 查询所有笔记
     */
    public List<Note> getAllNotes() {
        return loadAll();
    }
}
```

### 在页面中使用数据库

在 [DemoActivity.java](file:///D:/git/app/AndroidProject/app/src/main/java/run/yigou/gxzy/ui/activity/DemoActivity.java) 中添加数据库操作功能：

```java
// 添加数据库操作方法
private void saveNoteToDatabase() {
    Note note = new Note();
    note.setTitle("测试笔记");
    note.setContent("这是测试内容");
    
    long noteId = NoteService.getInstance().addNote(note);
    tvResult.setText("笔记保存成功，ID: " + noteId);
}

private void loadNotesFromDatabase() {
    List<Note> notes = NoteService.getInstance().getAllNotes();
    if (notes.isEmpty()) {
        tvResult.setText("暂无笔记");
    } else {
        StringBuilder sb = new StringBuilder();
        for (Note note : notes) {
            sb.append("标题: ").append(note.getTitle())
              .append("\n内容: ").append(note.getContent())
              .append("\n\n");
        }
        tvResult.setText(sb.toString());
    }
}
```

## 8.4 使用事件总线

在这一节中，我们将练习事件总线的使用。

### 创建事件类

创建一个简单的事件类：

```java
package run.yigou.gxzy.event;

/**
 * 笔记更新事件
 */
public class NoteUpdateEvent {
    private boolean isUpdated;
    
    public NoteUpdateEvent(boolean isUpdated) {
        this.isUpdated = isUpdated;
    }
    
    public boolean isUpdated() {
        return isUpdated;
    }
}
```

### 发送和接收事件

在 [DemoActivity.java](file:///D:/git/app/AndroidProject/app/src/main/java/run/yigou/gxzy/ui/activity/DemoActivity.java) 中添加事件总线功能：

```java
import com.lucas.xbus.XEventBus;
import com.lucas.annotations.Subscribe;

// 在 onCreate 方法中注册事件监听
@Override
protected void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_demo);
    
    // 注册事件监听
    XEventBus.getDefault().register(this);
    
    initView();
}

// 在 onDestroy 方法中注销事件监听
@Override
protected void onDestroy() {
    super.onDestroy();
    
    // 注销事件监听
    XEventBus.getDefault().unregister(this);
}

// 接收事件
@Subscribe
public void onNoteUpdate(NoteUpdateEvent event) {
    if (event.isUpdated()) {
        tvResult.setText("收到笔记更新通知");
        // 重新加载笔记列表
        loadNotesFromDatabase();
    }
}

// 发送事件
private void notifyNoteUpdate() {
    XEventBus.getDefault().post(new NoteUpdateEvent(true));
}
```

## 8.5 完整示例整合

将上述所有功能整合到一个完整的示例中：

```java
package run.yigou.gxzy.ui.activity;

import android.os.Bundle;
import android.view.View;
import android.widget.Button;
import android.widget.TextView;

import com.lucas.annotations.Subscribe;
import com.lucas.xbus.XEventBus;

import java.util.List;

import run.yigou.gxzy.R;
import run.yigou.gxzy.app.AppActivity;
import run.yigou.gxzy.event.NoteUpdateEvent;
import run.yigou.gxzy.greendao.entity.Note;
import run.yigou.gxzy.greendao.service.NoteService;
import run.yigou.gxzy.http.api.GetUserInfoApi;
import run.yigou.gxzy.http.model.HttpData;
import com.hjq.http.EasyHttp;
import com.hjq.http.listener.HttpCallback;
import com.hjq.widget.view.RegexEditText;
import com.hjq.widget.view.PasswordEditText;

/**
 * 演示页面 - 整合所有功能
 */
public class DemoActivity extends AppActivity 
        implements View.OnClickListener {
    
    private RegexEditText etUsername;
    private PasswordEditText etPassword;
    private Button btnLogin;
    private Button btnFetchUser;
    private Button btnSaveNote;
    private Button btnLoadNotes;
    private TextView tvResult;
    
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_demo);
        
        // 注册事件监听
        XEventBus.getDefault().register(this);
        
        initView();
    }
    
    private void initView() {
        etUsername = findViewById(R.id.et_username);
        etPassword = findViewById(R.id.et_password);
        btnLogin = findViewById(R.id.btn_login);
        btnFetchUser = findViewById(R.id.btn_fetch_user);
        btnSaveNote = findViewById(R.id.btn_save_note);
        btnLoadNotes = findViewById(R.id.btn_load_notes);
        tvResult = findViewById(R.id.tv_result);
        
        // 设置按钮点击监听
        btnLogin.setOnClickListener(this);
        btnFetchUser.setOnClickListener(this);
        btnSaveNote.setOnClickListener(this);
        btnLoadNotes.setOnClickListener(this);
        
        // 限制用户名只能输入字母和数字
        etUsername.setPatternRegex("[a-zA-Z0-9]*");
    }
    
    @Override
    public void onClick(View v) {
        if (v == btnLogin) {
            handleLogin();
        } else if (v == btnFetchUser) {
            fetchUserInfo();
        } else if (v == btnSaveNote) {
            saveNoteToDatabase();
        } else if (v == btnLoadNotes) {
            loadNotesFromDatabase();
        }
    }
    
    private void handleLogin() {
        String username = etUsername.getText().toString().trim();
        String password = etPassword.getText().toString().trim();
        
        if (username.isEmpty() || password.isEmpty()) {
            tvResult.setText("用户名或密码不能为空");
            return;
        }
        
        tvResult.setText("登录中...");
        
        simulateLogin(username, password);
    }
    
    private void simulateLogin(String username, String password) {
        getWindow().getDecorView().postDelayed(() -> {
            if ("admin".equals(username) && "123456".equals(password)) {
                tvResult.setText("登录成功");
            } else {
                tvResult.setText("用户名或密码错误");
            }
        }, 2000);
    }
    
    private void fetchUserInfo() {
        EasyHttp.get(this)
            .api(new GetUserInfoApi().setUserId("123"))
            .request(new HttpCallback<HttpData<GetUserInfoApi.Bean>>() {
                @Override
                public void onStart(Call call) {
                    tvResult.setText("正在获取用户信息...");
                }
                
                @Override
                public void onSucceed(HttpData<GetUserInfoApi.Bean> result) {
                    GetUserInfoApi.Bean userInfo = result.getData();
                    if (userInfo != null) {
                        String info = "用户名: " + userInfo.getUsername() + 
                                     "\n邮箱: " + userInfo.getEmail();
                        tvResult.setText(info);
                    } else {
                        tvResult.setText("未获取到用户信息");
                    }
                }
                
                @Override
                public void onFail(Exception e) {
                    tvResult.setText("获取用户信息失败: " + e.getMessage());
                }
                
                @Override
                public void onEnd(Call call) {
                }
            });
    }
    
    private void saveNoteToDatabase() {
        Note note = new Note();
        note.setTitle("测试笔记");
        note.setContent("这是测试内容");
        
        long noteId = NoteService.getInstance().addNote(note);
        tvResult.setText("笔记保存成功，ID: " + noteId);
        
        // 发送笔记更新事件
        XEventBus.getDefault().post(new NoteUpdateEvent(true));
    }
    
    private void loadNotesFromDatabase() {
        List<Note> notes = NoteService.getInstance().getAllNotes();
        if (notes.isEmpty()) {
            tvResult.setText("暂无笔记");
        } else {
            StringBuilder sb = new StringBuilder();
            for (Note note : notes) {
                sb.append("标题: ").append(note.getTitle())
                  .append("\n内容: ").append(note.getContent())
                  .append("\n\n");
            }
            tvResult.setText(sb.toString());
        }
    }
    
    @Subscribe
    public void onNoteUpdate(NoteUpdateEvent event) {
        if (event.isUpdated()) {
            tvResult.setText("收到笔记更新通知");
        }
    }
    
    @Override
    protected void onDestroy() {
        super.onDestroy();
        
        // 注销事件监听
        XEventBus.getDefault().unregister(this);
    }
}
```

## 本章小结

这一章我们通过实际的编码练习巩固了前面学到的知识：

1. **创建新页面**：学会了如何创建 Activity 和对应的布局文件
2. **网络请求**：掌握了如何使用 EasyHttp 框架发送网络请求
3. **数据库操作**：学会了如何使用 GreenDao 进行数据持久化
4. **事件总线**：掌握了如何使用 XEventBus 进行组件间通信
5. **综合应用**：将所有知识点整合到一个完整的示例中

通过这些练习，你应该能够独立开发基本的 Android 功能模块了。在实际开发中，可以根据具体需求灵活运用这些技术。