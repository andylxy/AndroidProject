# AI聊天功能优化任务清单及MVP架构说明

## 任务清单 (Task List)

### 已完成任务

1. ✅ 分析当前点击wx_add_chat_icon添加新会话的实现逻辑
2. ✅ 修改添加新会话功能，确保添加默认系统消息显示当前时间
3. ✅ 实现只有用户发送内容时才保存到数据库的逻辑
4. ✅ 确保消息列表只有系统消息时不进行数据库保存

### 功能实现详情

#### 1. 点击wx_add_chat_icon添加新会话功能
- 当用户点击右上角"+"图标时，会创建一个新的会话
- 自动为新会话添加一条系统消息，显示当前时间（HH:mm格式）
- 系统消息此时仅添加到UI界面，不保存到数据库
- 清空输入框内容
- 更新侧边栏会话列表
- 加载新创建的会话数据

#### 2. 数据库保存策略
- 会话创建时不会立即保存到数据库
- 系统消息仅在会话中已存在非系统消息时才会保存到数据库
- 用户消息仅在会话中已存在非系统消息时才会保存到数据库
- 若会话中只有系统消息，则用户发送的消息只显示在界面上，不保存到数据库

## MVP架构说明

### Model（模型层）
负责数据处理和业务逻辑：

1. **ChatMessageBean**
   - 消息实体类，包含消息类型、内容、时间等属性
   - 支持三种消息类型：发送(TYPE_SEND)、接收(TYPE_RECEIVED)、系统(TYPE_SYSTEM)

2. **ChatSessionBean**
   - 会话实体类，包含会话标题、预览内容、创建和更新时间等属性
   - 与多个ChatMessageBean关联

3. **DbService**
   - 数据库服务类，提供对ChatMessageBean和ChatSessionBean的增删改查操作
   - 使用GreenDAO框架实现数据持久化

### View（视图层）
负责界面展示和用户交互：

1. **AiMsgFragment**
   - 主要的聊天界面Fragment
   - 展示聊天记录列表(rv_chat)和侧边栏会话列表(chat_history_list)
   - 处理用户输入、发送消息、创建新会话等操作
   - 监听标题栏左右按钮点击事件

2. **TipsAiChatAdapter**
   - 聊天记录列表适配器
   - 根据不同类型的消息展示不同的布局(item_chat_send, item_chat_receive, item_chat_system)

3. **ChatHistoryAdapter**
   - 侧边栏会话列表适配器
   - 展示会话标题、预览内容、更新时间和消息数量

### Presenter（控制层）
连接Model和View，处理业务逻辑：

1. **消息发送流程**
   - 监听发送按钮点击事件
   - 检查当前会话状态（是否有非系统消息）
   - 根据检查结果决定是否保存消息到数据库
   - 调用AI助手获取回复
   - 更新UI界面和数据库

2. **会话管理**
   - 处理创建新会话逻辑
   - 管理会话与消息的关联关系
   - 同步侧边栏和主聊天区域的数据

3. **数据同步**
   - 确保UI界面与数据库数据的一致性
   - 处理会话切换时的数据加载
   - 实现消息的实时更新和持久化

## 核心优化点

1. **按需保存策略**
   - 避免产生大量空会话和无效消息
   - 减少不必要的数据库操作，提升性能
   - 确保数据库中保存的都是有效的用户交互数据

2. **系统消息处理**
   - 系统消息在创建新会话时立即显示，提升用户体验
   - 延迟保存系统消息到数据库，直到有实际用户交互发生
   - 减少数据库写入频率，提高效率

3. **会话生命周期管理**
   - 会话创建时仅在内存中维护，不立即持久化
   - 用户实际使用会话后才进行持久化保存
   - 避免因用户误操作产生垃圾数据