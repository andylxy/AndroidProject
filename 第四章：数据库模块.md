# 第四章：数据库模块

## 4.1 GreenDao 数据库简介

GreenDao 是一个用于 Android 的轻量级 ORM（对象关系映射）数据库框架。它将 Java 对象映射到 SQLite 数据库中的表，使开发者能够通过操作 Java 对象来操作数据库，而无需编写复杂的 SQL 语句。

### GreenDao 的优势

1. **高性能**：GreenDao 是目前性能最好的 ORM 数据库框架之一
2. **易使用**：提供了简洁的 API，易于上手
3. **类型安全**：编译时检查，减少运行时错误
4. **轻量级**：库体积小，对 APK 大小影响很小

## 4.2 数据库实体类（Entity）

在 GreenDao 中，实体类就是对应数据库中的表。每个实体类都需要使用 `@Entity` 注解标记。

### 示例：用户信息实体类

```java
@Entity
public class UserInfo {
    @Id
    private String id;
    
    // JWT token
    private String token;
    
    // 用户名
    private String userName;
    
    // 头像
    private String img;
    
    @NotNull
    private String userLoginAccount;
    
    // getter 和 setter 方法...
}
```

### 常用注解说明

- `@Entity`：标记这是一个数据库实体类
- `@Id`：标记这是主键字段
- `@NotNull`：标记该字段不能为空
- `@ToMany`：标记一对多关系

## 4.3 数据访问对象（DAO）

每个实体类都有对应的 DAO（Data Access Object）类，用于执行数据库操作。

### 自动生成的 DAO 类

GreenDao 会自动生成 DAO 类，如：
- [UserInfoDao](file:///D:/git/app/AndroidProject/app/src/main/java/run/yigou/gxzy/greendao/gen/UserInfoDao.java#L18-L60) - 用户信息数据访问对象
- [BookDao](file:///D:/git/app/AndroidProject/app/src/main/java/run/yigou/gxzy/greendao/gen/BookDao.java#L18-L57) - 书籍信息数据访问对象
- [ChapterDao](file:///D:/git/app/AndroidProject/app/src/main/java/run/yigou/gxzy/greendao/gen/ChapterDao.java#L18-L60) - 章节信息数据访问对象

## 4.4 服务类（Service）

为了让数据库操作更加方便，项目中为每个实体类创建了对应的服务类，继承自 [BaseService](file:///D:/git/app/AndroidProject/app/src/main/java/run/yigou/gxzy/greendao/service/BaseService.java#L15-L130)。

### 示例：用户信息服务类

```java
public class UserInfoService extends BaseService<UserInfo, UserInfoDao> {
    
    // 单例模式，确保全局只有一个实例
    private static class SingletonHolder {
        private static final UserInfoService INSTANCE = new UserInfoService();
    }

    public static UserInfoService getInstance() {
        return SingletonHolder.INSTANCE;
    }
    
    @Override
    protected Class<UserInfo> getEntityClass() {
        return UserInfo.class;
    }

    @Override
    protected UserInfoDao getDao() {
        tableName = UserInfoDao.TABLENAME;
        return daoSession.getUserInfoDao();
    }
    
    @Override
    protected void createTable() {
        UserInfoDao.createTable(mDatabase, true);
    }
    
    // 自定义的数据库操作方法
    public UserInfo getLoginUserInfo() {
        // 查询登录用户信息的逻辑
    }
}
```

## 4.5 数据库管理器

[GreenDaoManager](file:///D:/git/app/AndroidProject/app/src/main/java/run/yigou/gxzy/greendao/GreenDaoManager.java#L20-L75) 是数据库的管理类，负责数据库的初始化和会话管理。

```java
public class GreenDaoManager {
    private DaoMaster daoMaster;
    private DaoSession daoSession;
    
    private GreenDaoManager() {
        // 初始化数据库
        MySQLiteOpenHelper helper = new MySQLiteOpenHelper(
            AppApplication.getContext(), 
            AppConst.dbName, 
            null, 
            AppConfig.isDebug()
        );
        daoMaster = new DaoMaster(helper.getWritableDatabase());
        daoSession = daoMaster.newSession();
    }
    
    public static GreenDaoManager getInstance() {
        return SingletonHolder.INSTANCE;
    }
    
    public DaoSession getSession() {
        return daoSession;
    }
}
```

## 4.6 数据库工具类

项目中还提供了 [DbService](file:///D:/git/app/AndroidProject/app/src/main/java/run/yigou/gxzy/greendao/util/DbService.java#L28-L100) 工具类，统一管理所有的 Service 实例。

```java
public class DbService {
    public UserInfoService mUserInfoService;
    public BookService mBookService;
    // ... 其他服务
    
    private DbService() {
        mUserInfoService = UserInfoService.getInstance();
        mBookService = BookService.getInstance();
        // ... 初始化其他服务
    }
    
    public static DbService getInstance() {
        return SingletonHolder.INSTANCE;
    }
}
```

## 4.7 基本数据库操作

### 插入数据

```java
// 添加用户信息
UserInfo userInfo = new UserInfo();
userInfo.setId("1");
userInfo.setUserName("张三");
userInfo.setUserLoginAccount("zhangsan");

DbService.getInstance().mUserInfoService.insert(userInfo);
```

### 查询数据

```java
// 查询所有用户
List<UserInfo> userList = DbService.getInstance().mUserInfoService.loadAll();

// 根据条件查询
List<UserInfo> users = DbService.getInstance().mUserInfoService.queryBuilder()
    .where(UserInfoDao.Properties.UserName.eq("张三"))
    .list();
```

### 更新数据

```java
// 更新用户信息
UserInfo userInfo = DbService.getInstance().mUserInfoService.load("1");
userInfo.setUserName("李四");
DbService.getInstance().mUserInfoService.update(userInfo);
```

### 删除数据

```java
// 删除指定用户
DbService.getInstance().mUserInfoService.deleteByKey("1");

// 删除所有用户
DbService.getInstance().mUserInfoService.deleteAll();
```

## 4.8 在 Application 中初始化数据库

在 [AppApplication](file:///D:/git/app/AndroidProject/app/src/main/java/run/yigou/gxzy/app/AppApplication.java#L58-L317) 中初始化数据库服务：

```java
public class AppApplication extends Application {
    private UserInfoService mUserInfoService;
    
    @Override
    public void onCreate() {
        super.onCreate();
        
        // 初始化数据库服务
        mUserInfoService = DbService.getInstance().mUserInfoService;
        
        // 初始化用户登录状态
        initUserLogin();
    }
    
    private void initUserLogin() {
        try {
            UserInfo userInfo = mUserInfoService.getLoginUserInfo();
            if (userInfo != null) {
                // 设置登录状态和 token
                isLogin = true;
                EasyConfig.getInstance().addHeader("Authorization", userInfo.getToken());
            }
        } catch (Exception e) {
            // 处理异常
        }
    }
}
```

## 本章小结

这一章我们学习了：

1. GreenDao 数据库框架的基本概念和优势
2. 如何创建数据库实体类
3. DAO（数据访问对象）的作用
4. Service 服务类的使用
5. 数据库管理器和工具类
6. 基本的数据库操作（增删改查）
7. 在 Application 中初始化数据库

通过这些知识，你就能够在项目中使用数据库来存储和管理数据了。